name: Promote PDF to GCS

on:
  workflow_dispatch:
  push:
    paths:
      - 'current-version.txt'

env:
  GCS_BUCKET: whitepaper-pdfs-91fa25b2

jobs:
  promote-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: 'projects/347244006958/locations/global/workloadIdentityPools/github-pool/providers/github-actions-provider'
        service_account: 'whitepaper-github-actions@circles-production-1.iam.gserviceaccount.com'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Check GCS Bucket Access
      run: |
        gsutil ls gs://$GCS_BUCKET || {
          echo "❌ Bucket not accessible!" && exit 1
        }

    - name: Upload Current Version from Config
      id: select
      run: |
        echo "📤 Uploading current PDF version (as per config) to gs://$GCS_BUCKET/"
        
        CONFIG_FILE="current-version.txt"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "❌ $CONFIG_FILE not found!"
          exit 1
        fi

        CURRENT_PDF=$(cat "$CONFIG_FILE" | tr -d '[:space:]')
        
        if [ ! -f "$CURRENT_PDF" ]; then
          echo "❌ File '$CURRENT_PDF' listed in $CONFIG_FILE not found!"
          exit 1
        fi

        echo "📄 Selected PDF from config: $CURRENT_PDF"
        echo "pdf=$CURRENT_PDF" >> $GITHUB_OUTPUT

    - name: Upload PDF as latest.pdf
      run: |
        FILE="${{ steps.select.outputs.pdf }}"
        echo "📄 Uploading $FILE → latest.pdf"
        gsutil cp "$FILE" gs://$GCS_BUCKET/latest.pdf

        # Set content type and cache headers
        gsutil setmeta -h "Content-Type:application/pdf" gs://$GCS_BUCKET/latest.pdf
        gsutil setmeta -h "Cache-Control:public, max-age=3600" gs://$GCS_BUCKET/latest.pdf

        echo "✅ Upload complete. '$FILE' is now live at:"
        echo "   👉 https://whitepaper.aboutcircles.com"

    - name: Verify GCS sync
      run: |
        echo "📂 Current files in bucket:"
        gsutil ls -l gs://$GCS_BUCKET/

